<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParkAlisto Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease;
        }

        /* Dark Mode Colors (Default) */
        :root {
            --bg-color-main: #020617; /* slate-950 */
            --bg-color-card: #1E293B; /* slate-800 */
            --bg-color-header: #1e293b; /* slate-900 */
            --bg-color-header-blur: rgba(2, 6, 23, 0.95);
            --border-color: #334155;  /* slate-700 */
            --text-color-main: #E2E8F0;    /* slate-200 */
            --text-color-light: #94A3B8; /* slate-400 */
            --text-color-lighter: #64748B; /* slate-500 */
            --icon-color: #34D399; /* emerald-400 */
            --header-shadow-color: rgba(255, 255, 255, 0.05); /* subtle shadow for dark mode */
        }
        
        /* Light Mode Colors */
        body.light-mode {
            --bg-color-main: #F1F5F9; /* slate-100 */
            --bg-color-card: #FFFFFF; /* white */
            --bg-color-header: #FFFFFF; /* white */
            --bg-color-header-blur: rgba(255, 255, 255, 0.95);
            --border-color: #E2E8F0;  /* slate-200 */
            --text-color-main: #1E293B;    /* slate-800 */
            --text-color-light: #64748B; /* slate-500 */
            --text-color-lighter: #94A3B8; /* slate-400 */
            --icon-color: #10B981; /* emerald-500 */
            --header-shadow-color: rgba(0, 0, 0, 0.1);
        }

        /* Custom classes to use CSS variables */
        .main-bg { background-color: var(--bg-color-main); }
        .card-bg { background-color: var(--bg-color-card); }
        .header-bg { background-color: var(--bg-color-header); }
        .header-bg-blur { background-color: var(--bg-color-header-blur); }
        .card-border { border-color: var(--border-color); }
        .main-text { color: var(--text-color-main); }
        .light-text { color: var(--text-color-light); }
        .lighter-text { color: var(--text-color-lighter); }
        .icon-color { color: var(--icon-color); }

        .lot-name-card { background: linear-gradient(to bottom right, #059669, #047857); }
        
        /* Maintain fixed colors for these for contrast */
        .text-emerald-400 { color: #34D399; }
        .text-red-500 { color: #EF4444; }
        .text-yellow-400 { color: #FACC15; }
        .text-lime-500 { color: #84cc16; }

        .live-dot {
            animation: live-pulse 1.5s infinite;
        }

        @keyframes live-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(132, 204, 22, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(132, 204, 22, 0);
            }
        }
        
        /* Spinner animation for processing status */
        .spinner {
            border-top-color: var(--icon-color);
            border-left-color: var(--icon-color);
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="main-bg text-main-text transition-colors duration-500">
    <!-- Offline Indicator -->
    <div id="offline-banner" class="hidden fixed top-0 left-0 right-0 z-[100] p-3 text-center bg-red-800 text-white text-sm font-semibold shadow-2xl">
        You are currently viewing cached content (Offline Mode). Dynamic data will not update.
    </div>

    <!-- Header with backdrop-blur effect and updated design -->
    <header class="fixed top-0 left-0 right-0 z-50 grid grid-cols-3 items-center justify-between px-6 py-4 header-bg-blur backdrop-blur-sm border-b card-border">
        <!-- Left Section - ParkAlisto Logo (Default: Dark Mode) -->
        <div class="flex items-center">
            <img id="parkalisto-logo" 
                 src="assets/Logo_White_PA.png" 
                 onerror="this.src='assets/Logo_White_PA.png'" 
                 alt="ParkAlisto Logo" class="h-8">
        </div>
        
        <!-- Center Section (La Salle Logo) (Default: Dark Mode) -->
        <div class="flex items-center justify-center">
            <img id="lasalle-logo" 
                 src="assets/white_lasalle.png" 
                 onerror="this.src='assets/white_lasalle.png'" 
                 alt="La Salle Logo" class="h-10">
        </div>

        <!-- Right Section - Theme Toggle & Status Link -->
        <div class="flex items-center justify-end space-x-2">
            <!-- New Button for Parking Status Display -->
            <button id="status-link-btn" class="p-3 rounded-xl bg-slate-800/50 hover:bg-slate-700/50 border border-slate-600/50 hover:border-slate-500/50 transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-emerald-400/50" aria-label="Open parking status display">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-car h-5 w-5 icon-color">
                    <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"></path>
                    <circle cx="7" cy="17" r="2"></circle>
                    <path d="M9 17h6"></path>
                    <circle cx="17" cy="17" r="2"></circle>
                </svg>
            </button>
            
            <!-- Original Theme Toggle Button -->
            <button id="mode-toggle" class="p-3 rounded-xl bg-slate-800/50 hover:bg-slate-700/50 border border-slate-600/50 hover:border-slate-500/50 transition-all duration-300 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-emerald-400/50" aria-label="Switch to light mode">
                <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon h-5 w-5 icon-color">
                    <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
                </svg>
                <svg id="sun-icon" class="h-6 w-6 text-yellow-400 transition-transform duration-300 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364 1.364-1.591 1.591M21 12h-2.25m-1.364 6.364-1.591-1.591M12 18.75V21m-6.364-1.364-1.591 1.591M3 12H5.25m1.364-6.364 1.591 1.591M12 12a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5Z" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content Container -->
    <div class="container mx-auto p-4 max-w-7xl pt-24">
        <!-- Dashboard Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <div class="lg:col-span-2">
                <div class="space-y-6">
                    <div class="lot-name-card p-6 rounded-2xl shadow-xl border border-emerald-500/30">
                        <div class="flex items-center justify-center space-x-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin h-6 w-6 text-white">
                                <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            <div class="text-center">
                                <h2 class="text-xl font-bold text-white">La Salle Parking Lot</h2>
                                <p class="text-emerald-100 text-sm font-medium">Parking Lot â€“ 3rd Floor of USLS</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 rounded-2xl shadow-xl border card-border transition-all duration-500 card-bg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-car h-5 w-5 icon-color">
                                    <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"></path>
                                    <circle cx="7" cy="17" r="2"></circle>
                                    <path d="M9 17h6"></path>
                                    <circle cx="17" cy="17" r="2"></circle>
                                </svg>
                                <span class="text-sm font-medium light-text">Available Spots</span>
                            </div>
                            <div class="px-3 py-1 rounded-full text-xs font-medium bg-emerald-500/20 text-emerald-400">
                                <span id="occupancy-percent">0%</span> Full
                            </div>
                        </div>
                        <div class="flex items-end justify-between">
                            <div>
                                <h3 id="available-count" class="text-5xl font-bold icon-color">0</h3>
                                <p class="text-sm mt-1 light-text">of <span id="total-count" class="main-text font-semibold">0</span> spots</p>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="card-bg p-4 rounded-xl shadow-lg border card-border">
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                                <span class="text-xs font-medium light-text">Occupied</span>
                            </div>
                            <h4 id="occupied-count" class="text-2xl font-bold text-red-500">0</h4>
                        </div>
                        <div class="card-bg p-4 rounded-xl shadow-lg border card-border">
                            <div class="flex items-center space-x-2 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock w-3 h-3 text-yellow-400">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                <span class="text-xs font-medium light-text">Pending</span>
                            </div>
                            <h4 id="pending-count" class="text-2xl font-bold text-yellow-400">0</h4>
                        </div>
                    </div>
                    <div class="flex items-center justify-center space-x-2 text-xs lighter-text pt-2">
                        <span class="w-2 h-2 rounded-full bg-emerald-400"></span>
                        <span class="font-medium" id="last-update">Last updated: N/A</span>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-3">
                <div class="card-bg rounded-2xl shadow-xl border card-border overflow-hidden">
                    <div class="flex items-center justify-between p-4 border-b card-border">
                        <div class="flex items-center space-x-3">
                            <div class="p-2 bg-emerald-500/20 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-video h-4 w-4 icon-color">
                                    <path d="m22 8-6 4 6 4V8Z"></path>
                                    <rect width="14" height="12" x="2" y="6" rx="2" ry="2"></rect>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-sm font-semibold main-text">Live Camera Feed</h3>
                                <p class="text-xs light-text">3rd Floor - Parking</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="flex items-center space-x-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wifi h-3 w-3 icon-color">
                                    <path d="M12 20h.01"></path>
                                    <path d="M2 8.82a15 15 0 0 1 20 0"></path>
                                    <path d="M5 12.859a10 10 0 0 1 14 0"></path>
                                    <path d="M8.5 16.429a5 5 0 0 1 7 0"></path>
                                </svg>
                                <span class="text-xs icon-color font-medium" id="feed-status">Live</span>
                            </div>
                        </div>
                    </div>
                    <div id="video-container" class="relative w-full aspect-video bg-slate-900 group cursor-pointer">
                        <!-- Video feed source remains dynamic, but onerror uses local asset -->
                        <img id="video-feed" 
                             src="http://localhost:5000/video_feed" 
                             onerror="this.src='assets/feed-unavailable.png'" 
                             alt="Live parking lot camera feed" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/20 transition-opacity duration-300 opacity-0">
                            <div class="absolute top-4 left-4">
                                <div class="flex items-center space-x-2 bg-black/50 backdrop-blur-sm px-3 py-1 rounded-full">
                                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse" id="live-dot"></div>
                                    <span class="text-white text-xs font-medium" id="live-text">LIVE</span>
                                </div>
                            </div>
                        </div>
                        <button id="fullscreen-btn" class="absolute bottom-4 right-4 p-3 rounded-xl bg-black/50 backdrop-blur-sm text-white transition-all duration-300 hover:bg-black/70 hover:scale-105 z-20 focus:outline-none focus:ring-2 focus:ring-emerald-400/50 opacity-0 group-hover:opacity-100" aria-label="Enter fullscreen">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize w-5 h-5">
                                <path d="M8 3H5a2 2 0 0 0-2 2v3"></path>
                                <path d="M21 8V5a2 2 0 0 0-2-2h-3"></path>
                                <path d="M3 16v3a2 2 0 0 0 2 2h3"></path>
                                <path d="M16 21h3a2 2 0 0 0 2-2v-3"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connection and Queue Status Pill -->
        <div class="p-4 rounded-xl shadow-lg border transition-all duration-300 bg-emerald-500/10 border-emerald-500/20 mt-8">
            <div class="flex items-center justify-center space-x-6 text-sm font-semibold">
                
                <!-- Status 1: Connection -->
                <div class="flex items-center space-x-2">
                    <div id="connection-icon" class="text-emerald-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wifi h-4 w-4">
                            <path d="M12 20h.01"></path>
                            <path d="M2 8.82a15 15 0 0 1 20 0"></path>
                            <path d="M5 12.859a10 10 0 0 1 14 0"></path>
                            <path d="M8.5 16.429a5 5 0 0 1 7 0"></path>
                        </svg>
                    </div>
                    <p id="available-pill" class="text-emerald-400">Available: 0</p>
                </div>

                <!-- Separator -->
                <div class="h-4 w-px bg-emerald-400/50"></div>

                <!-- Status 2: Processing Queue Size -->
                <div class="flex items-center space-x-2">
                    <div id="queue-icon" class="text-indigo-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-checks h-4 w-4">
                            <path d="m3 16 2 2 4-4"></path>
                            <path d="m3 12 2 2 4-4"></path>
                            <path d="M12 5h9"></path>
                            <path d="M12 9h9"></path>
                            <path d="M12 13h9"></path>
                            <path d="M12 17h9"></path>
                        </svg>
                    </div>
                    <p id="queue-pill" class="text-indigo-400">Queue: 0 cars</p>
                </div>
            </div>
        </div>
        
        <!-- Parking History Card -->
        <div class="card-bg p-6 rounded-2xl shadow-xl border card-border mt-8">
            <div class="flex items-center space-x-3 mb-4">
                <div class="p-2 bg-indigo-500/20 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history h-4 w-4 text-indigo-400">
                        <path d="M3 10a9.01 9.01 0 1 1 1.7-5.5"></path>
                        <path d="M3 10a9.01 9.01 0 1 1 1.7-5.5"></path>
                        <path d="M3 10a9.01 9.01 0 1 1 1.7-5.5"></path>
                        <path d="M12 4v7h7"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-sm font-semibold main-text">Parking History</h3>
                    <p class="text-xs light-text">Recent parking activity logs (asynchronous update)</p>
                </div>
            </div>
            <div id="history-list" class="space-y-4">
                <p class="text-center light-text">Loading history...</p>
            </div>
        </div>
    </div>

    <!-- Screenshot Modal (Hidden by default) -->
    <div id="screenshot-modal" class="hidden fixed inset-0 z-[101] bg-black/80 flex items-center justify-center transition-opacity duration-300 opacity-0" onclick="closeModal()">
        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-2xl max-w-lg w-11/12" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center pb-3 border-b border-gray-200 dark:border-slate-700">
                <h3 class="text-lg font-semibold main-text" id="modal-title">Plate Screenshot</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors" aria-label="Close modal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x w-6 h-6"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>
            <div class="mt-4">
                <img id="modal-image" src="" alt="Vehicle Plate Screenshot" class="w-full h-auto rounded-lg">
                <p id="modal-caption" class="text-sm light-text mt-2 text-center"></p>
            </div>
        </div>
    </div>

    <script>
        // --- Element References ---
        const occupiedCountEl = document.getElementById('occupied-count');
        const totalCountEl = document.getElementById('total-count');
        const availableCountEl = document.getElementById('available-count');
        const pendingCountEl = document.getElementById('pending-count');
        const lastUpdateEl = document.getElementById('last-update');
        const occupancyPercentEl = document.getElementById('occupancy-percent');
        const availablePillEl = document.getElementById('available-pill'); // Changed from statusPillEl
        const queuePillEl = document.getElementById('queue-pill');
        const modeToggle = document.getElementById('mode-toggle');
        const moonIcon = document.getElementById('moon-icon');
        const sunIcon = document.getElementById('sun-icon');
        const body = document.body;
        const feedStatusEl = document.getElementById('feed-status');
        const liveDotEl = document.getElementById('live-dot');
        const liveTextEl = document.getElementById('live-text');
        const connectionIconEl = document.getElementById('connection-icon');
        const offlineBanner = document.getElementById('offline-banner');

        const videoContainer = document.getElementById('video-container');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const videoFeed = document.getElementById('video-feed');
        const lasalleLogo = document.getElementById('lasalle-logo');
        const parkalistoLogo = document.getElementById('parkalisto-logo');
        const historyListEl = document.getElementById('history-list');

        // --- Modal Elements ---
        const screenshotModal = document.getElementById('screenshot-modal');
        const modalImage = document.getElementById('modal-image');
        const modalCaption = document.getElementById('modal-caption');
        const modalTitle = document.getElementById('modal-title');

        // --- Modal Functions ---
        window.showModal = function(imageFilename, spotId, plate) {
            const imageUrl = `http://localhost:5000/plate_screenshots/${imageFilename}`;
            modalImage.src = imageUrl;
            modalTitle.textContent = `Spot ${spotId} Plate Screenshot`;
            modalCaption.textContent = `Vehicle Plate: ${plate}`;
            
            screenshotModal.classList.remove('hidden', 'opacity-0');
            screenshotModal.classList.add('opacity-100');
        }

        window.closeModal = function() {
            screenshotModal.classList.add('opacity-0');
            // Wait for the transition to finish before hiding completely
            setTimeout(() => {
                screenshotModal.classList.add('hidden');
            }, 300); 
        }

        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Ensure the service worker path is correct for caching all static assets
                navigator.serviceWorker.register('./service-worker.js', { scope: './' })
                    .then(registration => {
                        console.log('Service Worker registered successfully with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
        
        // Function to handle connection status UI updates
        function setOnlineStatus(isOnline) {
            if (isOnline) {
                offlineBanner.classList.add('hidden');
                connectionIconEl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wifi h-4 w-4"><path d="M12 20h.01"></path><path d="M2 8.82a15 15 0 0 1 20 0"></path><path d="M5 12.859a10 10 0 0 1 14 0"></path><path d="M8.5 16.429a5 5 0 0 1 7 0"></path></svg>';
                connectionIconEl.classList.remove('text-red-500');
                connectionIconEl.classList.add('text-emerald-400');
                feedStatusEl.textContent = 'Live';
                liveDotEl.classList.remove('bg-gray-400', 'animate-none');
                liveDotEl.classList.add('bg-red-500', 'animate-pulse');
                liveTextEl.textContent = 'LIVE';
            } else {
                offlineBanner.classList.remove('hidden');
                connectionIconEl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cloud-off h-4 w-4"><path d="M22 13a4.5 4.5 0 0 0-4.5-4.5c-.324 0-.642.046-.948.134.33-1.01.5-2.062.5-3.134a6 6 0 0 0-12 0c0 .949.208 1.83.585 2.622M4 11.02a5 5 0 0 0 4 8h9a4 4 0 0 0 0-8"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>';
                connectionIconEl.classList.remove('text-emerald-400');
                connectionIconEl.classList.add('text-red-500');
                feedStatusEl.textContent = 'Offline';
                liveDotEl.classList.remove('bg-red-500', 'animate-pulse');
                liveDotEl.classList.add('bg-gray-400', 'animate-none');
                liveTextEl.textContent = 'CACHED';
            }
        }

        // Function to fetch and update the parking data
        async function updateData() {
            try {
                // Add a unique timestamp to prevent browser caching (only for live data)
                const response = await fetch('http://localhost:5000/data?_=' + new Date().getTime());
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();

                // Update data counts
                const availableSpots = Math.max(0, data.total - data.occupied);
                occupiedCountEl.textContent = data.occupied;
                totalCountEl.textContent = data.total;
                availableCountEl.textContent = availableSpots;
                pendingCountEl.textContent = data.pending;
                lastUpdateEl.textContent = `Last updated: ${data.last_update}`;
                
                // NEW: Update available and queue pills
                availablePillEl.textContent = `Available: ${availableSpots}`;
                queuePillEl.textContent = `Queue: ${data.queue_size} cars`;


                const occupancyPercentage = data.total > 0 ? Math.round((data.occupied / data.total) * 100) : 0;
                occupancyPercentEl.textContent = `${occupancyPercentage}%`;
                
                setOnlineStatus(true);

            } catch (error) {
                console.warn("Failed to fetch parking data, attempting offline display:", error);
                
                // Set UI to reflect offline state
                occupiedCountEl.textContent = "N/A";
                totalCountEl.textContent = "N/A";
                availableCountEl.textContent = "N/A";
                pendingCountEl.textContent = "N/A";
                lastUpdateEl.textContent = "Last updated: OFFLINE";
                occupancyPercentEl.textContent = "N/A";
                availablePillEl.textContent = "Status: OFFLINE";
                queuePillEl.textContent = "Queue: N/A";

                setOnlineStatus(false);
            }
        }
        
        // Function to fetch and update the parking history log
        async function updateHistory() {
            try {
                const response = await fetch('http://localhost:5000/parking_history?_=' + new Date().getTime());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const history = await response.json();
                
                historyListEl.innerHTML = ''; // Clear previous content

                if (history.length === 0) {
                    historyListEl.innerHTML = '<p class="text-center light-text">No parking activity has been logged yet.</p>';
                } else {
                    history.forEach(entry => {
                        const isLeaving = entry.is_active === false;
                        const isProcessing = entry.plate_number === "Processing...";

                        // Determine card colors
                        let cardColor, textColor, statusText;
                        if (isProcessing) {
                            cardColor = 'border-indigo-500/20 bg-indigo-500/10';
                            textColor = 'text-indigo-400';
                            statusText = 'Queued';
                        } else {
                            cardColor = isLeaving ? 'border-red-500/20' : 'border-emerald-500/20';
                            textColor = isLeaving ? 'text-red-400' : 'text-emerald-400';
                            statusText = isLeaving ? 'Left' : 'Parked';
                        }

                        const timeText = isLeaving ? entry.timestamp_out : entry.timestamp_in;

                        let plateDisplayHtml;
                        if (isProcessing) {
                            // Show spinner and processing text
                            plateDisplayHtml = `
                                <span class="flex items-center space-x-2 font-semibold text-indigo-400">
                                    <div class="spinner border-2 border-r-transparent border-b-transparent light-text"></div>
                                    <span>Processing...</span>
                                </span>
                            `;
                        } else {
                            // Show final plate number or 'N/A'
                            const plateText = entry.plate_number !== 'N/A' ? entry.plate_number : 'Plate N/A';
                            plateDisplayHtml = `<span class="font-semibold main-text">Plate:</span> ${plateText}`;
                        }


                        // Plate Image Icon Logic
                        let plateImageIcon = '';
                        if (entry.plate_image && entry.plate_image !== 'N/A') {
                            const plateNumberDisplay = isProcessing ? 'PROCESSING' : (entry.plate_number !== 'N/A' ? entry.plate_number : 'UNRECOGNIZED');
                            plateImageIcon = `
                                <button onclick="event.stopPropagation(); showModal('${entry.plate_image}', '${entry.spot_id}', '${plateNumberDisplay}')" 
                                        class="ml-2 p-1 rounded-full bg-indigo-500/20 text-indigo-400 hover:bg-indigo-500/30 transition-colors"
                                        title="View Plate Screenshot">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera w-4 h-4"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                                </button>`;
                        }

                        const listItem = document.createElement('div');
                        listItem.className = `card-bg p-4 rounded-xl shadow-lg border ${cardColor} transition-all duration-300 transform hover:scale-[1.01]`;
                        listItem.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="font-bold text-lg main-text">Spot ${entry.spot_id}</span>
                                    <span class="text-xs font-medium px-2 py-1 rounded-full ${textColor} bg-emerald-500/20">${statusText}</span>
                                </div>
                                <span class="light-text text-xs">${timeText}</span>
                            </div>
                            <div class="mt-2 flex items-center space-x-4 light-text">
                                <p class="flex-grow flex items-center">
                                    ${plateDisplayHtml}
                                    ${plateImageIcon}
                                </p>
                                <p class="flex-grow">
                                    <span class="font-semibold main-text">Vehicle:</span> ${entry.vehicle_type}
                                </p>
                                <p class="flex-grow">
                                    <span class="font-semibold main-text">Color:</span> ${entry.color}
                                </p>
                            </div>
                        `;
                        historyListEl.appendChild(listItem);
                    });
                }
            } catch (error) {
                console.warn("Failed to fetch parking history. Showing offline message.", error);
                historyListEl.innerHTML = '<p class="text-center text-red-400">ðŸš¨ Failed to load live history. Data is unavailable offline.</p>';
            }
        }

        // --- Theme Toggle Logic ---
        function setMode(isLightMode) {
            // UPDATED Local Asset Paths based on user's specification
            const lasalleDarkLogoUrl = 'assets/white_lasalle.png';
            const parkalistoDarkLogoUrl = 'assets/Logo_White_PA.png';
            const lasalleLightLogoUrl = 'assets/black_lasalle.png';
            const parkalistoLightLogoUrl = 'assets/Logo_Black_PA.png';

            if (isLightMode) {
                body.classList.add('light-mode');
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
                // Use Light Mode Local Asset Paths
                lasalleLogo.src = lasalleLightLogoUrl;
                parkalistoLogo.src = parkalistoLightLogoUrl;
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.remove('light-mode');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                // Use Dark Mode Local Asset Paths
                lasalleLogo.src = lasalleDarkLogoUrl;
                parkalistoLogo.src = parkalistoDarkLogoUrl;
                localStorage.setItem('theme', 'dark');
            }
        }

        // Check for saved preference on page load
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            setMode(true);
        } else {
            setMode(false); // Default to dark mode if no preference is saved
        }

        // Toggle function
        modeToggle.addEventListener('click', () => {
            const isLightMode = body.classList.contains('light-mode');
            setMode(!isLightMode);
        });
        
        // --- Parking Status Link Logic ---
        const statusLinkBtn = document.getElementById('status-link-btn');
        statusLinkBtn.addEventListener('click', () => {
            // Note: status_display.html must also be cached by the Service Worker to work offline.
            window.open('status_display.html', '_blank'); 
        });

        // Fetch data initially and then every 2 seconds
        updateData();
        updateHistory();
        setInterval(() => {
            updateData();
            updateHistory();
        }, 2000);
        
        // Add error handling for video feed
        videoFeed.onerror = function() {
            console.error('Video feed failed to load');
            // This is the local asset path for the fallback image
            this.src = 'assets/feed-unavailable.png';
            this.alt = 'Video feed unavailable';
            setOnlineStatus(false);
        };
        
        videoFeed.onload = function() {
             console.log('Video feed loaded successfully');
        };

        // --- Fullscreen Logic ---
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                videoContainer.requestFullscreen().then(() => {
                    // Update button icon when in fullscreen
                    fullscreenBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-minimize w-5 h-5">
                            <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path>
                        </svg>`;
                }).catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen().then(() => {
                    // Update button icon when exiting fullscreen
                    fullscreenBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize w-5 h-5">
                            <path d="M8 3H5a2 2 0 0 0-2 2v3"></path>
                            <path d="M21 8V5a2 2 0 0 0-2-2h-3"></path>
                            <path d="M3 16v3a2 2 0 0 0 2 2h3"></path>
                            <path d="M16 21h3a2 2 0 0 0 2-2v-3"></path>
                        </svg>`;
                });
            }
        }
        
        // Add click event listener to the fullscreen button
        fullscreenBtn.addEventListener('click', toggleFullscreen);

        // --- Network Status Event Listeners (Basic Fallback) ---
        window.addEventListener('online', () => {
             console.log('Back online. Attempting to update data.');
             updateData();
             updateHistory();
        });
        window.addEventListener('offline', () => {
             console.log('Went offline. Displaying cached content.');
             setOnlineStatus(false);
        });

    </script>
</body>
</html>
